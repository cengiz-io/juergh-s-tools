#!/bin/bash -eu
#
# Build and download debs using CBD
#

function usage()
{
	cat <<EOF
Usage: cbd-build [-h] [-d DIR] [-- OPTS]

Build and download Debian packages using CBD.

Positional arguments:
  OPTS                 Additional options for 'git push cbd'.

Optional arguments:
  -h, --help           Show this help text and exit.
  -d, --directory DIR  Directory to download the Debian packages to. If not
                       provided, defaults to '../cbdd/<git_hash>'.
EOF
}

output_dir=

while [ $# -gt 0 ] ; do
	case "${1}" in
		-d|--directory)
			shift
			output_dir=${1}
			;;
		-h|--help)
			usage
			exit
			;;
		--)
			shift
			break
			;;
		-*)
			echo "Invalid argument: ${1}" >&2
			exit 2
			;;
	esac
	shift
done

# Add cbd remote if necessary
if ! git remote | grep -q '^cbd$' ; then
	# shellcheck disable=SC1091
	. debian/debian.env
	series=$(dpkg-parsechangelog -l "${DEBIAN}"/changelog -S Distribution)
	git remote add cbd cbd:"${series}".git
fi

# Build
git push cbd -o vars "${@}" 2>&1 | tee cbd-build.log

# Source the CBD variables
eval "$(sed -n 's/^remote: CBD/CBD/p' cbd-build.log)"
if [ -z "${CBD_JOB:-}" ] || [ -z "${CBD_GIT_HASH:-}" ] ; then
	echo "Failed to source CBD variables" >&2
	exit 1
fi

if [ -z "${output_dir}" ] ; then
	output_dir=../cbdd/${CBD_GIT_HASH}
	rm -rf "${output_dir}"
fi

# Download
echo "-- Downloading build artifacts to ${output_dir}"
cbd-download -o "${output_dir}" "${CBD_JOB}"
