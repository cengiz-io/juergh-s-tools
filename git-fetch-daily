#!/bin/sh -u
#
# Update git repo mirrors
#

fetch_repo()
{
	date -R
	echo "-- Fetching $(pwd)/${1}"

	git -C "${1}" fetch --prune --all --tags
	date -R > "${1}"/.fetched
}

if ! cd "${1}" ; then
	echo "-- Failed to cd to ${1}" >&2
	exit 1
fi

# Fetch the main linux repo first (since all the others use it as a
# reference)
fetch_repo linux.git

# Update the fixes file
echo "Finding fixes commits"
find-fixes linux.git linux.fixes

# Fetch the remaining repos
for git_dir in *.git ; do
	if [ -d "${git_dir}" ] && [ "${git_dir}" != "linux.git" ] ; then
		fetch_repo "${git_dir}"
	fi
done
