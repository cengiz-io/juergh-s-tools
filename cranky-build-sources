#!/bin/bash -eu

function out()
{
	local rc=${?}

	trap - EXIT

	if [ "${rc}" -ne 0 ] ; then
		echo "Script failed" >&2
	fi

	exit "${rc}"
}

function set_pkg_build_opts()
{
	local package=${1} version=${2}

	case "${package}" in
		linux-meta*)
			BO_META+=("-v${version}")
			;;
		linux-signed*)
			BO_SIGNED+=("-v${version}")
			;;
		linux-restricted-modules*)
			BO_LRM+=("-v${version}")
			;;
		linux*)
			BO_MAIN+=("-v${version}")
			;;
		*)
			echo "Unsupported package: ${package}" >&2
			exit 1
	esac
}

function usage()
{
	cat <<EOF
Usage: cranky-build-sources [-c] [-f] [-h] [-n] [-o] POCKET|OFFSET|ABI

Build a set of kernel packages.

Positional arguments:
  POCKET       Get the previous package versions from pocket POCKET.
  OFFSET       Get the previous package versions from the changelogs using
               changelog entry offset OFFSET (1 == previous changelog entry).
  ABI          Get the previous package versions from the changelogs using
               the newest changelog entry with abi number ABI.

Optional arguments:
  -c, --current  Only build the source package for the current directory.
  -f, --force    Force the build even if the repos are unclean.
  -h, --help     Show this help text and exit.
  -n, --no-orig  Don't require an orig source tarball.
  -o, --orig     Include the orig source tarball in the upload.
EOF
}

CRANKY=${CRANKY:-cranky}

current=0
force=0
pocket=
offset=
abi=
build_opts=()

BO_META=()
BO_SIGNED=()
BO_LRM=()
BO_MAIN=()

while [ "${#}" -gt 0 ] ; do
	case "${1}" in
		-c|--current)
			current=1
			build_opts+=("--current")
			;;
		-f|--force)
			force=1
			;;
		-h|--help)
			usage
			exit
			;;
		-n|--no-orig)
			build_opts+=("--no-orig")
			;;
		-o|--orig)
			BO_MAIN+=("-sa")
			;;
		updates|release|security|proposed)
			if [ -n "${pocket}${offset}${abi}" ] ; then
				echo "Invalid argument: ${1}" >&2
				exit 2
			fi
			pocket=${1}
			;;
		[1-9])
			if [ -n "${pocket}${offset}${abi}" ] ; then
				echo "Invalid argument: ${1}" >&2
				exit 2
			fi
			offset=${1}
			;;
		[0-9]*.[0-9]*.[0-9]*-[0-9]*)
			if [ -n "${pocket}${offset}${abi}" ] ; then
				echo "Invalid argument: ${1}" >&2
				exit 2
			fi
			abi=${1}
			;;
		*)
			echo "Invalid argument: ${1}" >&2
			exit 2
			;;
	esac
	shift
done

if [ -z "${pocket}${offset}${abi}" ] ; then
	usage
	exit 2
fi

trap out EXIT

if [ "${force}" -eq 0 ] ; then
	clean=1
	if [ ${current} -eq 1  ] ; then
		# Verify that then current source repo is clean
		if [ -n "$(git status --porcelain)" ] ; then
			echo "${PWD}: Repo is unclean" >&2
			clean=0
		fi
	else
		# Verify that all source repos are clean
		while IFS= read -r path ; do
			if [ -n "$(git -C "${path}" status --porcelain)" ] ; then
				echo "${path}: Repo is unclean" >&2
				clean=0
			fi
		done < <("${CRANKY}" shell-helper source-packages-path)
	fi
	if [ "${clean}" -eq 0 ] ; then
		echo "Use -f, --force to auto-clean before the build" >&2
		exit 1
	fi
fi

if [ -n "${offset}${abi}" ] ; then
	# Use the package version from the changelog
	while IFS= read -r path ; do
		if [ ${current} -eq 1 ] && [ "${path}" != "$(realpath .)" ] ; then
			continue
		fi

		DEBIAN=debian
		if [ -e "${path}"/debian/debian.env ] ; then
			# shellcheck disable=SC1091
			. "${path}"/debian/debian.env
		fi

		if [ -n "${offset}" ] ; then
			# Use the provided offset
			package=$(dpkg-parsechangelog -l "${path}"/"${DEBIAN}"/changelog \
			                              -o "${offset}" -c 1 -S source)
			version=$(dpkg-parsechangelog -l "${path}"/"${DEBIAN}"/changelog \
			                              -o "${offset}" -c 1 -S version)
		else
			# Use the provided ABI
			v=${abi%-*}
			v=${v//./\\.}
			u=${abi#*-}
			match=$(grep -m1 "^linux.* (${v}[-.]${u}\." \
			        "${path}"/"${DEBIAN}"/changelog)
			if [ -z "${match}" ] ; then
				echo "Unable to find a changelog entry with ABI: ${abi}" >&2
				exit 1
			fi
			package=${match%% *}
			version=${match#* \(}
			version=${version%\) *}
		fi

		set_pkg_build_opts "${package}" "${version}"
	done < <("${CRANKY}" shell-helper source-packages-path)

else
	# Get the previous versions from the provided pocket
	found=0
	while IFS=' ' read -r package version rest ; do
		found=1
		set_pkg_build_opts "${package}" "${version}"
	done < <("${CRANKY}" rmadison -s -p "${pocket}")

	if [ ${found} -eq 0 ] ; then
		echo "Invalid pocket: ${pocket}" >&2
		exit 1
	fi
fi

if [ ${#BO_META[@]} -ne 0 ] ; then
	build_opts+=("--build-opts" "meta:${BO_META[*]}")
fi
if [ ${#BO_SIGNED[@]} -ne 0 ] ; then
	build_opts+=("--build-opts" "signed:${BO_SIGNED[*]}")
fi
if [ ${#BO_LRM[@]} -ne 0 ] ; then
	build_opts+=("--build-opts" "lrm:${BO_LRM[*]}")
fi
if [ ${#BO_MAIN[@]} -ne 0 ] ; then
	build_opts+=("--build-opts" "main:${BO_MAIN[*]}")
fi

echo -e "\e[33m${CRANKY} build-sources ${build_opts[*]}\e[0m"
"${CRANKY}" build-sources "${build_opts[@]}"
